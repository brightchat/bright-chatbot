# DynamoDB Backend

Implementation of a backend that uses AWS DynamoDB as the data store.

This backend also stores the image responses generated by the Dall-E model into a separate table.

## DynamoDB Tables

### Sessions

Logs the current active sessions of the users. A session is analogue to a conversation between the user and the bot.

Sessions are unique for each user while they are active.

| Property | Description | Type | Is PK | Is SK |
| -------- | ----------- | ---- | ----- | ----- |
| UserId | Identifier of the **User** object associated with the session | Text (SHA256 from user's phone number) | Yes | No
| SessionId | Identifier of the session that an user is on | Text (UserId + ":" + TimestampCreated) | No | Yes
| TimestampCreated | UNIX Timestamp for when the session was created | Numeric | No | No
| TimestampFinished | UNIX Timestamp for when the session was forcefully finished | Numeric | No | No
| MessagesQuota | Number of messages that the user can send in the session | Numeric | No | No
| SessionConfig | Configuration of the session in a JSON-encoded text | Text (JSON) | No | No
| SessionTTL | UNIX Timestamp denoting the time when the session will expire (Around 3 hours after session creation) | Numeric | No | No

> `SessionTTL` is a TimeToLive property that specifies date and time when the item in the table will expire (See [DynamoDB TTL](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/TTL.html) for more information).

### Chats

Logs the timestamp of the messages and responses that are sent in a chat during a session.

| Property | Description | Type | Is PK | Is SK |
| -------- | ----------- | ---- | ----- | ----- |
| SessionId | Identifier of the session, a conversation between the user and the bot | Text (UserId + ":" + TimestampCreated) | Yes | No
| UserId | Identifier of the **User** associated with the chat | Text (Hashed phone number) | No | No
| TimestampCreated | UNIX Timestamp for when the message was created by either the bot or the user | Numeric | No | Yes
| ChatAgent | Agent that sent the message. Can be either `assistant` (Our bot) or `user` | Text (Enum) | No | No
| ImageId | When response contains an image, unique identifier of the image in the `ImageResponses` table | Text (SHA256 from `image_b64`) | No | No

> Global seconday index "UserConverationGlobalIndex" on: `(UserId (PK), TimestampCreated (SK))`.
> Global seconday index "UsersLastMessageGlobalIndex" on: `(UserId (PK))`.

### ChatMessages

Stores the messages that are sent in a chat during a session to keep track of an active converation, for privacy reasons, the messages are only stored for the time
that the session is active using a TTL property `SessionTTL`.

| Property | Description | Type | Is PK | Is SK |
| -------- | ----------- | ---- | ----- | ----- |
| SessionId | Identifier of the session | Text (UserId + ":" + TimestampCreated) | Yes | No
| TimestampCreated | UNIX Timestamp for when the message was created by either the bot or the user | Numeric | No | Yes
| SessionTTL | UNIX Timestamp denoting the time when the session will expire (Around 3 hours after session creation) | Numeric | No | No

> `SessionTTL` is a TimeToLive property that specifies date and time when the item in the table will expire (See [DynamoDB TTL](https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/TTL.html) for more information).

### ImageResponses

Image responses obtained from the image-generation API (*Dall-E*).

| Property | Description | Type | Is PK | Is SK |
| -------- | ----------- | ---- | ----- | ----- |
| ImageId | Unique identifier for the image | Text (SHA256 from the `ImageData` content) | Yes | No
| UserId | Identifier of the **User** that generated the image | Text (Hashed phone number) | No | No
| Prompt | Natural language prompt sent to the Image generation API | Text | No | No
| ImageURI | URI of the image | Text | No | No
| TimestampCreated | UNIX Timestamp for when the image was created by the Image generation API | Numeric | No | No

> Global seconday index "PromptGlobalIndex" on: `(Prompt (PK), TimestampCreated (Sk))`.
